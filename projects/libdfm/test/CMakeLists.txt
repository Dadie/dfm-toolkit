cmake_minimum_required(VERSION 3.14)

create_test_sourcelist (TEST_SOURCES
  libdfm_test_main.cpp # Autogenerated!
  utils_ci_string_cmp.cpp
  utils_bits.cpp
  lexer_lex.cpp
  lexer_weed.cpp
  pt_pp.cpp
  pt_weed_pp.cpp
)

add_executable (libdfm_tests ${TEST_SOURCES})
target_link_libraries(libdfm_tests PUBLIC libdfm)
target_compile_options(libdfm_tests PRIVATE "-Wall")
target_compile_options(libdfm_tests PRIVATE "-Wpedantic")
target_compile_options(libdfm_tests PRIVATE "-Wextra")
target_compile_options(libdfm_tests PRIVATE "-pthread")
target_compile_options(libdfm_tests PRIVATE "-fPIC")
target_compile_options(libdfm_tests PRIVATE "-O3")
set_property(TARGET libdfm_tests PROPERTY CXX_STANDARD 23)

set (TestFiles ${TEST_SOURCES})
# Remove autogenerated main file
remove (TestFiles libdfm_test_main.cpp)
# Remove per DFM file tests
remove (TestFiles lexer_lex.cpp)
remove (TestFiles lexer_weed.cpp)
remove (TestFiles pt_pp.cpp)
remove (TestFiles pt_weed_pp.cpp)

foreach (TestFilename ${TestFiles})
  get_filename_component (TestName ${TestFilename} NAME_WE)
  add_test (NAME ${TestName} COMMAND libdfm_tests ${TestName})
endforeach ()

# Add per DFM file tests
file(GLOB dfm_files LIST_DIRECTORIES false ABSOLUTE ${CMAKE_CURRENT_SOURCE_DIR} "../../../etc/dfm/in/*.dfm")
foreach(dfm_path ${dfm_files})
  get_filename_component (TestName ${dfm_path} NAME_WLE)
  add_test (NAME "lexer_lex_${TestName}" COMMAND libdfm_tests "lexer_lex" ${dfm_path})
  add_test (NAME "lexer_weed_${TestName}" COMMAND libdfm_tests "lexer_weed" ${dfm_path})
  add_test (NAME "pt_pp_${TestName}" COMMAND libdfm_tests "pt_pp" ${dfm_path})
  add_test (NAME "pt_weed_pp_${TestName}" COMMAND libdfm_tests "pt_weed_pp" ${dfm_path})
endforeach()
